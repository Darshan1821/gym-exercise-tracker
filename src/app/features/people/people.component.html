<div class="p-6 max-w-7xl mx-auto">

    <!-- ================= HEADER ================= -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <input placeholder="Search people..." class="input w-full sm:max-w-md"
            (input)="setSearch($any($event.target).value)" />

        <button class="hidden sm:flex w-11 h-11 rounded-full bg-primary text-white
             items-center justify-center text-xl shadow-sm" (click)="showAddPerson = true" aria-label="Add person">
            +
        </button>
    </div>

    <!-- ================= PEOPLE LIST ================= -->
    <div class="space-y-4">
        <ng-container *ngIf="filteredPeople$ | async as people">
            <div *ngFor="let p of people" class="border rounded-xl overflow-hidden transition"
                @expandCollapse
                [class.opacity-60]="!p.active" [class.bg-neutral-100]="!p.active">

                <!-- ===== CARD HEADER ===== -->
                <div class="p-4 flex items-center justify-between">

                    <!-- Left: Avatar + Info -->
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center
                     text-white font-semibold" [style.background]="p.color">
                            {{ p.firstName[0] }}{{ p.lastName[0] }}
                        </div>

                        <div>
                            <p class="font-medium text-text">
                                {{ p.firstName }} {{ p.lastName }}
                            </p>

                            <p class="text-xs text-text-muted">
                                Age {{ p.age }} · Height {{ p.height }} cm
                            </p>

                            <!-- Disabled pill -->
                            <div *ngIf="!p.active" class="inline-flex items-center gap-2 mt-1
                       text-xs px-2 py-0.5 rounded-full
                       bg-gray-200 text-gray-600">
                                <span>Disabled</span>

                                <button class="text-primary font-medium hover:underline" (click)="enablePerson(p)">
                                    Enable
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Latest Stats + Expand -->
                    <div class="flex items-center gap-4">

                        <!-- Latest weight & BMI -->
                        <div *ngIf="p.active && getLatest(p.id!) as latest" class="text-right text-sm">
                            <div class="text-text">
                                {{ latest.weight }} kg
                            </div>

                            <div class="font-medium" [ngClass]="getBmiColorClass(latest.bmi)">
                                BMI {{ latest.bmi }}
                            </div>
                        </div>

                        <!-- Expand button -->
                        <button *ngIf="p.active" class="w-8 h-8 rounded-full border border-border
                     flex items-center justify-center
                     hover:bg-neutral-100 transition" (click)="toggleExpand(p)" aria-label="Toggle details">
                            <span class="text-sm transition-transform" [class.rotate-180]="expandedPersonId === p.id">
                                ▼
                            </span>
                        </button>
                    </div>
                </div>

                <!-- ===== EXPANSION PANEL ===== -->
                <div *ngIf="expandedPersonId === p.id" class="border-t border-border bg-neutral-50 p-4 space-y-6">

                    <!-- Header actions -->
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-text">Details</h3>

                        <button class="text-danger text-sm hover:underline" (click)="disablePerson(p)">
                            Disable
                        </button>
                    </div>

                    <!-- Monthly Records -->
                    <div>
                        <h4 class="font-medium mb-2">Monthly Records</h4>

                        <div class="space-y-2">
                            <div *ngFor="let r of weightMap.get(p.id!)" class="flex justify-between items-center
                       border border-border rounded-lg p-2 text-sm">
                                <span>{{ r.month }}/{{ r.year }}</span>
                                <span>{{ r.weight }} kg</span>

                                <span class="font-medium" [ngClass]="getBmiColorClass(r.bmi)">
                                    BMI {{ r.bmi }}
                                </span>

                                <div class="flex gap-2">
                                    <button class="text-primary text-xs hover:underline" (click)="editRecord(r)">
                                        Edit
                                    </button>

                                    <button class="text-danger text-xs hover:underline"
                                        (click)="openDeleteModal(p.id!, r.id!)">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add / Update Monthly Weight -->
                    <div>
                        <h4 class="font-medium mb-2">
                            {{ editingRecordId ? 'Update' : 'Add' }} Monthly Weight
                        </h4>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <select class="input" [(ngModel)]="form.year">
                                <option *ngFor="let y of years" [value]="y">
                                    {{ y }}
                                </option>
                            </select>

                            <select class="input" [(ngModel)]="form.month">
                                <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">
                                    {{ m }}
                                </option>
                            </select>

                            <input type="number" class="input" placeholder="Weight (kg)" [(ngModel)]="form.weight" />
                        </div>

                        <div class="flex justify-end gap-2 mt-3">
                            <button *ngIf="editingRecordId" class="border border-border px-3 py-1 rounded text-sm"
                                (click)="resetForm()">
                                Cancel
                            </button>

                            <button class="bg-primary hover:bg-primary-hover
                       text-white px-4 py-1 rounded text-sm" (click)="addOrUpdateRecord(p)">
                                {{ editingRecordId ? 'Update' : 'Add' }}
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </ng-container>
    </div>

    <div *ngIf="showDeleteModal" class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm space-y-4">
            <h3 class="font-semibold">Delete Weight Record?</h3>
            <p class="text-sm text-gray-500">
                This action cannot be undone.
            </p>
            <div class="flex justify-end gap-2">
                <button class="border px-4 py-2 rounded" (click)="cancelDelete()">Cancel</button>
                <button class="bg-danger text-white px-4 py-2 rounded" (click)="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- ================= MOBILE ADD BUTTON ================= -->
    <button class="sm:hidden fixed bottom-6 right-6
           w-14 h-14 rounded-full
           bg-primary text-white text-2xl shadow-lg" (click)="showAddPerson = true" aria-label="Add person">
        +
    </button>

    <!-- ================= ADD PERSON DIALOG ================= -->
    <app-add-person-dialog *ngIf="showAddPerson" (close)="showAddPerson = false" (save)="addPerson($event)" />

    <!-- ================= TOAST ================= -->
    <!-- ================= MODERN TOAST ================= -->
    <div *ngIf="toast.show" class="fixed top-5 right-5 z-50
         flex items-start gap-3
         px-4 py-3 rounded-xl
         shadow-lg border
         animate-slide-in" [ngClass]="{
    'bg-red-50 border-red-200 text-red-800': toast.type === 'error',
    'bg-green-50 border-green-200 text-green-800': toast.type === 'success'
  }">
        <!-- Accent bar -->
        <div class="w-1.5 rounded-full self-stretch" [ngClass]="{
      'bg-red-500': toast.type === 'error',
      'bg-green-500': toast.type === 'success'
    }"></div>

        <!-- Message -->
        <div class="flex-1 text-sm font-medium leading-snug">
            {{ toast.message }}
        </div>

        <!-- Close -->
        <button class="text-gray-400 hover:text-gray-600 transition" (click)="toast.show = false"
            aria-label="Close notification">
            ✕
        </button>
    </div>
</div>